#include "common.h"
	
//////////////////////////////////////////////////////////////////////////////////////////

// Pixel
#include "pnv.h"

Texture2D 	s_vp2;

float resize(float input, float factor, float offset)
{
	return (input - 0.5f + offset) / factor + 0.5f - offset;
}

float4 main	(p_flat I, float4 pos2d : SV_Position): SV_Target
{
	
	float4 t_base = s_base.Sample(smp_base, I.tcdh); // Текстура сетки
	I.tcdh.x = resize(I.tcdh.x, screen_res.x / screen_res.y, 0);		
	
	float4 t_svp = s_vp2.Load( int3(pos2d.xy, 0) );
	
	if (!isSecondVPActive()) {
		t_svp.rgb /= 100; //KRodin: чтобы изображение во втором вьюпорте не застывало после его отключения - просто затемним его в 100 раз.
	} else if (m_blender_mode.x == 1.f) { //Зеленый ПНВ
		t_svp.rgb = calc_night_vision_effect(I.tcdh, t_svp, float3(0.66, 2.0, 0.5));
	} else if (m_blender_mode.x == 2.f) { //Фейковый тепловизор, на самом деле ПНВ с красным оттенком
		t_svp.rgb = calc_night_vision_effect(I.tcdh, t_svp, float3(0.79, 0.191, 0.247));
	}
	
	float3 final = lerp(t_svp, t_base, t_base.a); // Сетку с вьюпортом
	
	return float4(final.r, final.g, final.b, m_hud_params.x);
}
